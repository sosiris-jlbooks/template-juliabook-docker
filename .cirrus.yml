jupyter_book_task:
  only_if: $CIRRUS_BRANCH == $CIRRUS_DEFAULT_BRANCH || $CIRRUS_BASE_BRANCH == $CIRRUS_DEFAULT_BRANCH
  env:
    JOBS: 1
    # GH_TOKEN: ENCRYPTED[!04189b6db63eaba858d6fe34cdb03b95e6cae73980fe91b4631181cf2fc8f5dbe376202c32d86be51999e102557d13af!]
  auto_cancellation: true
  container:
    dockerfile: .github/cirrus.Dockerfile
    cpu: 1
    memory: 4G
    greedy: true
  notebook_script: >
    parallel --joblog /tmp/log -j${JOBS}
    jupyter nbconvert --to notebook
    --ExecutePreprocessor.timeout=600
    --execute --inplace
    {} ::: docs/*.ipynb
  execution_results_script:   cat /tmp/log
  build_script: |
    jupyter-book build docs/ --keep-going
  ## Requires a repo scope access GitHub PAT encrypted to `GH_TOKEN` to push to its GitHub repo
  # pages_script: |
  #   if [[ $CIRRUS_BRANCH == $CIRRUS_DEFAULT_BRANCH ]]; then
  #     git remote set-url origin https://${GH_TOKEN}@github.com/${CIRRUS_REPO_FULL_NAME}.git
  #     ghp-import -n -p -f docs/_build/html
  #   fi

# Requires a repo & package write access GitHub PAT encrypted to `GH_TOKEN`
env:
  GH_TOKEN: ENCRYPTED[a83a3d33c85c1d0439cbfdb99f81551f87b7bfc3de072a36822d8019ef5f7d5a4aa6c7f47c975db2afa3a3c60f24384d]
  NO_PUSH: "true"

jupyter_book_task:
  only_if: $CIRRUS_BRANCH == 'main' || $CIRRUS_TAG != '' || $CIRRUS_PR != ''
  auto_cancellation: true
  env:
    JOBS: 1
    TIMEOUT: 600
  container:
    dockerfile: cirrus.Dockerfile
    cpu: 1
    memory: 4G
    greedy: true
  notebook_script: >
    find docs/ -name '*.ipynb' |
    parallel -j${JOBS} --joblog /tmp/log
    jupyter nbconvert --to notebook
    --ExecutePreprocessor.timeout=${TIMEOUT}
    --ExecutePreprocessor.kernel_name="julia-$(julia -e 'print(VERSION.major, ".", VERSION.minor)')"
    --execute --inplace
  stats_script: cat /tmp/log
  build_script: jupyter-book build docs/ --keep-going
  pages_script: |
    if [[ ${CIRRUS_BRANCH} == 'main' && ${NO_PUSH} != 'true' ]]; then
      echo "Deploying to GitHub pages..."
      git remote set-url origin https://${GH_TOKEN}@github.com/${CIRRUS_REPO_FULL_NAME}.git
      ghp-import -nofp docs/_build/html
    fi

docker_builder:
  name: Build binder image
  only_if: $CIRRUS_BRANCH == 'main'
  auto_cancellation: true
  depends_on:
    - jupyter_book
  env:
    IMAGE_NAME: ghcr.io/${CIRRUS_REPO_FULL_NAME}:binder
    DOCKER_USERNAME: ${CIRRUS_REPO_OWNER}
    DOCKER_PASSWORD: ${GH_TOKEN}
  repo2docker_script: |
    pip install -U pip setuptools wheel
    pip install https://github.com/jupyterhub/repo2docker/archive/main.zip
  login_script: echo ${DOCKER_PASSWORD} | docker login --username ${DOCKER_USERNAME} --password-stdin
  pull_image_scipt: docker pull ${IMAGE_NAME} || true
  build_image_script: >
    jupyter-repo2docker
    --no-run --no-push
    --image-name ${IMAGE_NAME}
    --cache-from ${IMAGE_NAME}
    .
  push_image_script:
    if [[ ${NO_PUSH} != 'true' ]]; then
      docker push ${IMAGE_NAME}
    fi
